# Issues

このドキュメントは、MAGI System MCPリポジトリの既知の問題点をGitHubのissue形式でまとめています。

---

## 🐛 Codex CLIのタイムアウト問題

### 問題の概要
Proposal Battle実行時に、Codex CLIがタイムアウト（120秒）を超えて応答を返せない場合がある。

### 再現手順
1. ホストラッパーを起動: `uvicorn host_wrappers.codex_wrapper:app --host 127.0.0.1 --port 9001`
2. Dockerブリッジを起動: `docker-compose up`
3. Proposal Battleを実行:
   ```bash
   curl -X POST http://127.0.0.1:8787/magi/start \
     -H "Content-Type: application/json" \
     -d '{"initial_prompt": "このリポジトリのリファクタリングについて", "skip_claude": true}'
   ```
4. 結果: Codexからスタブレスポンスが返る（`httpx.ReadTimeout`）

### 期待される動作
- Codex CLIが120秒以内に応答を返す
- 実際のLLMレスポンスが取得できる

### 実際の動作
- Codex CLIが120秒を超えて実行を続ける
- タイムアウトが発生し、スタブレスポンスが返る
- メタデータに `cli_type: "real"` が含まれ、接続は試みられている

### 環境情報
- OS: macOS
- Codex CLI: `codex exec --skip-git-repo-check`
- タイムアウト設定: 120秒（`WRAPPER_TIMEOUT`環境変数またはデフォルト値）

### 考えられる原因
1. **Codex CLIの応答が遅い**
   - Codex CLIは対話的エージェントで、複数のステップを実行する
   - ファイル読み込み、思考プロセス、実行などで時間がかかる
   - 特に長いプロンプトや複雑なタスクの場合、120秒では不十分な可能性

2. **Codex CLIプロセスがハングしている**
   - プロセスが正常に終了せず、応答を返さない
   - 標準出力への書き込みがブロックされている可能性

3. **タイムアウト設定が不十分**
   - 現在120秒だが、実際には180秒以上かかる可能性

### 関連ファイル
- `src/magi/clients/base_client.py`: HTTPクライアントのタイムアウト設定（120秒）
- `host_wrappers/base_wrapper.py`: ラッパーのタイムアウト設定（120秒）
- `host_wrappers/codex_wrapper.py`: Codexラッパーの実装

### 解決策の提案
1. **タイムアウトをさらに延長**（180秒または240秒）
2. **Codex CLIの応答時間を監視**し、実際の応答時間を測定
3. **プログレス表示の実装**（Codex CLIが進行中であることを示す）
4. **タイムアウト設定を環境変数で柔軟に変更可能にする**

### ステータス
🔴 **Open** - 調査中

---

## ⚠️ プロセスクリーンアップの問題

### 問題の概要
タイムアウトやエラー発生時に、CLIプロセスが確実に終了しない場合がある。

### 再現手順
1. Proposal Battleを実行
2. タイムアウトが発生する
3. プロセス一覧を確認: `ps aux | grep -E "codex|gemini" | grep -v grep`
4. 結果: タイムアウト後もCLIプロセスが実行中

### 期待される動作
- タイムアウト時にプロセスが確実に終了する
- エラー発生時もプロセスがクリーンアップされる

### 実際の動作
- タイムアウト時に `proc.kill()` を呼び出しているが、プロセスが残る場合がある
- 特にCodex CLIプロセスが長時間実行され続ける

### 環境情報
- OS: macOS
- Python: 3.11+ (Dockerコンテナ内)

### 考えられる原因
1. **プロセスグループの問題**
   - `proc.kill()` が子プロセスを終了させられない
   - Codex CLIが複数の子プロセスを生成している可能性

2. **シグナル処理の問題**
   - `SIGTERM` が無視されている
   - `SIGKILL` が必要だが、適切に送信されていない

### 関連ファイル
- `host_wrappers/base_wrapper.py`: プロセスクリーンアップの実装
- `host_wrappers/gemini_wrapper.py`: Geminiラッパーのプロセスクリーンアップ

### 解決策の提案
1. **プロセスグループ全体を終了させる**
   ```python
   os.killpg(os.getpgid(proc.pid), signal.SIGKILL)
   ```
2. **タイムアウト前に警告を出す**（例: 60秒経過時に警告）
3. **プロセス監視の実装**（定期的にプロセスが存在するか確認）

### ステータス
🟡 **Partially Fixed** - 基本的なクリーンアップは実装済みだが、完全ではない

---

## 📝 エラーハンドリングの改善余地

### 問題の概要
エラー発生時の詳細情報がスタブレスポンスに含まれるが、デバッグが困難な場合がある。

### 再現手順
1. Proposal Battleを実行
2. エラーが発生する
3. スタブレスポンスのメタデータを確認
4. 結果: エラー詳細が含まれているが、ログとの対応が難しい

### 期待される動作
- エラー詳細が明確に表示される
- ログとメタデータが対応している
- デバッグが容易

### 実際の動作
- エラーログはDockerコンテナのログに出力される
- メタデータに `error` と `note` が含まれる
- スタックトレースはログにのみ出力される

### 環境情報
- ログ出力: Dockerコンテナの標準出力
- メタデータ: APIレスポンスに含まれる

### 考えられる改善点
1. **エラーメッセージの統一**
   - エラーメッセージのフォーマットを統一
   - エラーコードの導入

2. **ログとメタデータの対応**
   - リクエストIDの導入
   - ログとメタデータを関連付ける

3. **エラーの分類**
   - タイムアウト、接続エラー、CLIエラーなど
   - エラータイプに応じた処理

### 関連ファイル
- `src/magi/clients/base_client.py`: エラーハンドリングの実装
- `src/api/server.py`: APIエラーハンドリング

### 解決策の提案
1. **リクエストIDの導入**
2. **エラーメッセージの構造化**
3. **エラーログの集約**（ファイル出力など）

### ステータス
🟡 **Enhancement** - 機能は動作しているが、改善の余地がある

---

## 🔍 その他の観察事項

### Gemini CLIの動作
- ✅ 正常に動作している
- ✅ タイムアウト90秒→120秒の延長が有効
- ✅ 位置引数+stdinの実装が機能している

### Claude CLIの使用制限
- ⚠️ 使用制限に達している（5-hour limit）
- ⚠️ これはCLI側の問題で、システム側の問題ではない
- ✅ `skip_claude` オプションで回避可能

### システム全体の状態
- ✅ Dockerブリッジ: 正常に動作
- ✅ ホストラッパー: 正常に起動
- ✅ URL解決のフォールバック: 正常に動作
- ⚠️ Codex CLI: タイムアウト問題

---

## 📋 まとめ

### 優先度: 高
1. **Codex CLIのタイムアウト問題** - 実際のLLMレスポンスが取得できない

### 優先度: 中
2. **プロセスクリーンアップの問題** - リソースリークの可能性

### 優先度: 低
3. **エラーハンドリングの改善** - デバッグの容易さ向上

---

## 🔗 関連リンク
- [README.md](./README.md) - プロジェクトの概要とセットアップ手順
- [src/magi/clients/base_client.py](./src/magi/clients/base_client.py) - LLMクライアントの実装
- [host_wrappers/](./host_wrappers/) - HTTPラッパーの実装

