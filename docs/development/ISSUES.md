# Issues

このドキュメントは、MAGI System MCPリポジトリの既知の問題点をGitHubのissue形式でまとめています。

---

## 🐛 Codex CLIのタイムアウト問題

### 問題の概要
Proposal Battle実行時に、Codex CLIがタイムアウト（120秒）を超えて応答を返せない場合がある。

**重要な理解**: CLIは正常に稼働しているが、回答までに時間がかかっている。CLIがハングしているわけではなく、処理に時間がかかっているだけである。

### 再現手順
1. ホストラッパーを起動: `uvicorn host_wrappers.codex_wrapper:app --host 127.0.0.1 --port 9001`
2. Dockerブリッジを起動: `docker-compose up`
3. Proposal Battleを実行:
   ```bash
   curl -X POST http://127.0.0.1:8787/magi/start \
     -H "Content-Type: application/json" \
     -d '{"initial_prompt": "このリポジトリのリファクタリングについて", "skip_claude": true}'
   ```
4. 結果: Codexからスタブレスポンスが返る（`httpx.ReadTimeout`）

### 期待される動作
- Codex CLIが十分な時間内に応答を返す
- 実際のLLMレスポンスが取得できる
- 処理に時間がかかる場合でも、タイムアウト前に完了する

### 実際の動作
- Codex CLIは正常に動作しているが、処理に時間がかかる
- 120秒のタイムアウト設定では不十分な場合がある
- タイムアウトが発生し、スタブレスポンスが返る
- メタデータに `cli_type: "real"` が含まれ、接続は試みられている
- CLIプロセス自体は正常に動作を続けている（ハングしていない）

### 環境情報
- OS: macOS
- Codex CLI: `codex exec --skip-git-repo-check`
- タイムアウト設定: 120秒（`WRAPPER_TIMEOUT`環境変数またはデフォルト値）

### 原因の分析
1. **Codex CLIの処理に時間がかかる（主な原因）**
   - Codex CLIは対話的エージェントで、複数のステップを実行する
   - ファイル読み込み、思考プロセス、実行などで時間がかかる
   - 特に長いプロンプトや複雑なタスクの場合、120秒では不十分
   - **CLIは正常に動作しているが、完了までに時間がかかる**

2. **タイムアウト設定が不十分**
   - 現在120秒だが、実際には180秒以上かかる可能性がある
   - 環境変数で調整可能だが、デフォルト値が短すぎる可能性

3. **プログレス表示の欠如**
   - CLIが処理中であることが分からない
   - タイムアウト前に処理が完了するかどうかが不明

### 関連ファイル
- `src/magi/clients/base_client.py`: HTTPクライアントのタイムアウト設定（120秒）
- `host_wrappers/base_wrapper.py`: ラッパーのタイムアウト設定（120秒）
- `host_wrappers/codex_wrapper.py`: Codexラッパーの実装

### 解決策の提案
1. **タイムアウトをさらに延長**（180秒または240秒）
   - Codex CLI用のデフォルトタイムアウトを延長
   - 環境変数 `CODEX_TIMEOUT` または `WRAPPER_TIMEOUT` で調整可能にする

2. **Codex CLIの応答時間を監視**し、実際の応答時間を測定
   - 実際の処理時間を記録して、適切なタイムアウト値を決定

3. **プログレス表示の実装**（Codex CLIが進行中であることを示す）
   - CLIが処理中であることを示すメカニズムを実装
   - タイムアウト前に処理が完了するかどうかを判断できるようにする

4. **非同期処理の改善**
   - CLIが正常に動作している場合、タイムアウトで強制終了するのではなく、処理を継続できるようにする
   - または、より長いタイムアウトを設定する

5. **タイムアウト設定を環境変数で柔軟に変更可能にする**（既に実装済み）
   - `CODEX_TIMEOUT`: Codex CLI専用のタイムアウト
   - `WRAPPER_TIMEOUT`: ラッパー全体のタイムアウト
   - `LLM_TIMEOUT`: すべてのLLMのタイムアウト

### ステータス
🟡 **確認済み** - CLIは正常に動作しているが、処理に時間がかかる。タイムアウト設定の見直しが必要。

---

## ⚠️ プロセスクリーンアップの問題

### 問題の概要
タイムアウトやエラー発生時に、CLIプロセスが確実に終了しない場合がある。

### 再現手順
1. Proposal Battleを実行
2. タイムアウトが発生する
3. プロセス一覧を確認: `ps aux | grep -E "codex|gemini" | grep -v grep`
4. 結果: タイムアウト後もCLIプロセスが実行中

### 期待される動作
- タイムアウト時にプロセスが確実に終了する
- エラー発生時もプロセスがクリーンアップされる

### 実際の動作
- タイムアウト時に `proc.kill()` を呼び出しているが、プロセスが残る場合がある
- 特にCodex CLIプロセスが長時間実行され続ける

### 環境情報
- OS: macOS
- Python: 3.11+ (Dockerコンテナ内)

### 考えられる原因
1. **プロセスグループの問題**
   - `proc.kill()` が子プロセスを終了させられない
   - Codex CLIが複数の子プロセスを生成している可能性

2. **シグナル処理の問題**
   - `SIGTERM` が無視されている
   - `SIGKILL` が必要だが、適切に送信されていない

3. **CLIが正常に動作している場合の処理**
   - CLIが正常に処理を続けている場合、タイムアウトで強制終了するのは適切ではない可能性
   - タイムアウト設定を延長するか、非同期処理を改善する必要がある

### 関連ファイル
- `host_wrappers/base_wrapper.py`: プロセスクリーンアップの実装
- `host_wrappers/gemini_wrapper.py`: Geminiラッパーのプロセスクリーンアップ

### 解決策の提案
1. **プロセスグループ全体を終了させる**
   ```python
   os.killpg(os.getpgid(proc.pid), signal.SIGKILL)
   ```
2. **タイムアウト前に警告を出す**（例: 60秒経過時に警告）
3. **プロセス監視の実装**（定期的にプロセスが存在するか確認）

### ステータス
🟡 **Partially Fixed** - 基本的なクリーンアップは実装済みだが、完全ではない

---

## 📝 エラーハンドリングの改善余地

### 問題の概要
エラー発生時の詳細情報がスタブレスポンスに含まれるが、デバッグが困難な場合がある。

### 再現手順
1. Proposal Battleを実行
2. エラーが発生する
3. スタブレスポンスのメタデータを確認
4. 結果: エラー詳細が含まれているが、ログとの対応が難しい

### 期待される動作
- エラー詳細が明確に表示される
- ログとメタデータが対応している
- デバッグが容易

### 実際の動作
- エラーログはDockerコンテナのログに出力される
- メタデータに `error` と `note` が含まれる
- スタックトレースはログにのみ出力される

### 環境情報
- ログ出力: Dockerコンテナの標準出力
- メタデータ: APIレスポンスに含まれる

### Phase 1での改善
✅ **実装済み** - Phase 1で以下の改善を実装：

1. **型安全なエラーハンドリング**
   - `LLMSuccess`/`LLMFailure`クラスでエラーを型レベルで区別
   - エラータイプ（timeout, http_error, cli_missing, exception）を明示的に分類
   - 実行時間の自動計測

2. **構造化ロギング**
   - JSON形式のログ出力
   - コンテキスト情報（session_id, trace_id, model等）の自動付与
   - ログとメタデータの対応が容易に

3. **エラーメッセージの改善**
   - エラータイプに応じた詳細なメッセージ
   - フォールバックコンテンツの明示的な管理

### 関連ファイル
- `src/magi/models.py`: `LLMSuccess`/`LLMFailure`クラス
- `src/magi/clients/base_client.py`: `generate_with_result()`メソッド
- `src/magi/logging_config.py`: 構造化ロギングシステム

### 今後の改善点
1. **リクエストIDの導入**（Phase 2候補）
2. **エラーログの集約**（ファイル出力など）（Phase 2候補）
3. **エラーメトリクスの収集**（Phase 2候補）

### ステータス
✅ **Phase 1で大幅改善** - 型安全性とロギングが向上。さらなる改善はPhase 2で検討。

---

## 🔍 その他の観察事項

### Gemini CLIの動作
- ✅ 正常に動作している
- ✅ タイムアウト90秒→120秒の延長が有効
- ✅ 位置引数+stdinの実装が機能している

### Claude CLIの使用制限
- ⚠️ 使用制限に達している（5-hour limit）
- ⚠️ これはCLI側の問題で、システム側の問題ではない
- ✅ `skip_claude` オプションで回避可能

### システム全体の状態
- ✅ Dockerブリッジ: 正常に動作
- ✅ ホストラッパー: 正常に起動
- ✅ URL解決のフォールバック: 正常に動作
- ⚠️ Codex CLI: タイムアウト問題

---

## 📋 まとめ

### 優先度: 高
1. **Codex CLIのタイムアウト問題** - CLIは正常に動作しているが、処理に時間がかかるためタイムアウト設定の見直しが必要

### 優先度: 中
2. **プロセスクリーンアップの問題** - リソースリークの可能性

### 優先度: 低
3. **エラーハンドリングの改善** - デバッグの容易さ向上

---

## 🔗 関連リンク
- [README.md](./README.md) - プロジェクトの概要とセットアップ手順
- [src/magi/clients/base_client.py](./src/magi/clients/base_client.py) - LLMクライアントの実装
- [host_wrappers/](./host_wrappers/) - HTTPラッパーの実装

